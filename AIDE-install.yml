---
- name: Ensure AIDE is installed and initialized
  hosts: all
  become: yes
  tasks:
    - name: Install AIDE
      yum:
        name: aide
        state: present

    - name: Backup existing AIDE database (Pre-Initialization)
      shell: cp /var/lib/aide/aide.db.gz /var/lib/aide/aide.db.gz-before-$(date +%Y%m%d-%H%M%S)
      args:
        removes: /var/lib/aide/aide.db.gz
      ignore_errors: yes  # Prevent failure if no previous database exists

    - name: Initialize AIDE database
      command: aide --init
      args:
        creates: /var/lib/aide/aide.db.new.gz

    - name: Move AIDE database
      command: mv /var/lib/aide/aide.db.new.gz /var/lib/aide/aide.db.gz
      args:
        removes: /var/lib/aide/aide.db.new.gz

    - name: Backup new AIDE database (Post-Initialization)
      shell: cp /var/lib/aide/aide.db.gz /var/lib/aide/aide.db.gz-after-$(date +%Y%m%d-%H%M%S)
