  tasks:
    - name: Check if GDM package is installed
      package_facts:

    - name: Set GDM installed flag
      set_fact:
        gdm_installed: "{{ 'gdm' in ansible_facts.packages }}"

    - name: Warn if GDM is not installed
      debug:
        msg: "GDM is not installed. Skipping automount configuration."
      when: not gdm_installed

    - name: Continue only if GDM is installed
      block:
        - name: Ensure dconf database directory exists
          file:
            path: "{{ dconf_db_dir }}"
            state: directory
            owner: root
            group: root
            mode: '0755'

        - name: Backup existing dconf settings file if it exists
          copy:
            src: "{{ dconf_settings_file }}"
            dest: "{{ backup_file }}"
            remote_src: yes
          when: ansible_facts['files'][dconf_settings_file] is defined

        - name: Create dconf settings file to disable automount
          copy:
            dest: "{{ dconf_settings_file }}"
            content: |
              [org/gnome/desktop/media-handling]
              automount=false
              automount-open=false
            owner: root
            group: root
            mode: '0644'

        - name: Ensure dconf profile file exists and has correct line
          lineinfile:
            path: "{{ dconf_profile_file }}"
            line: "system-db:{{ dconf_profile_name }}"
            insertafter: "^user-db:user"
            create: yes
            state: present

        - name: Update dconf database
          command: dconf update

      when: gdm_installed

    - name: Notify user to manually reboot for changes to take effect
      debug:
        msg: "Task complete. Please manually reboot the system to apply changes."
